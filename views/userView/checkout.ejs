<!DOCTYPE html>
<html lang="zxx">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Male_Fashion Template" />
    <meta name="keywords" content="Male_Fashion, unica, creative, html" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Sole Saavy</title>
    <link rel="shortcut icon" type="image/png" href="/img/Favicon.jpg" />

    <!-- Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap"
      rel="stylesheet"
    />

    <!-- Css Styles -->
    <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="css/elegant-icons.css" type="text/css" />
    <link rel="stylesheet" href="css/magnific-popup.css" type="text/css" />
    <link rel="stylesheet" href="css/nice-select.css" type="text/css" />
    <link rel="stylesheet" href="css/owl.carousel.min.css" type="text/css" />
    <link rel="stylesheet" href="css/slicknav.min.css" type="text/css" />
    <link rel="stylesheet" href="css/style.css" type="text/css" />
    <style>
      .error{
        color: red;
      }
    </style>
  </head>

  <body>
    <!-- Page Preloder -->
    <div id="preloder">
      <div class="loader"></div>
    </div>

    <!-- Offcanvas Menu Begin -->
    <div class="offcanvas-menu-overlay"></div>
    <div class="offcanvas-menu-wrapper">
      <div class="offcanvas__option">
        <div class="offcanvas__links">
          <a href="#">Sign in</a>
          <a href="#">FAQs</a>
        </div>
        <div class="offcanvas__top__hover">
          <span>Usd <i class="arrow_carrot-down"></i></span>
          <ul>
            <li>USD</li>
            <li>EUR</li>
            <li>USD</li>
          </ul>
        </div>
      </div>
      <div class="offcanvas__nav__option">
        <a href="#" class="search-switch"
          ><img src="img/icon/search.png" alt=""
        /></a>
        <a href="#"><img src="img/icon/heart.png" alt="" /></a>
        <a href="#"><img src="img/icon/cart.png" alt="" /> <span>0</span></a>
        <div class="price">$0.00</div>
      </div>
      <div id="mobile-menu-wrap"></div>
      <div class="offcanvas__text">
        <p>Free shipping, 30-day return or refund guarantee.</p>
      </div>
    </div>
    <!-- Offcanvas Menu End -->

   <!-- Header Section Begin -->
   <header class="header">
    <div class="header__top">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 col-md-7">
                    <div class="header__top__left">
                        <p>Free shipping, 30-day return or refund guarantee.</p>
                    </div>
                </div>
                <div class="col-lg-6 col-md-5">
                    <div class="header__top__right">
                        <div class="header__top__links">
                            <a href="/Register">Sign in</a>
                            <a href="/logout">Sign Out</a>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="col-lg-3 col-md-3">
                <div class="header__logo">
                    <a href="./home"><img class="logo" src="/img/ssLOGO.png" alt=""></a>
                </div>
            </div>
            <div class="col-lg-6 col-md-6">
                <nav class="header__menu mobile-menu">
                    <ul>
                        <li ><a href="/home">Home</a></li>
                        <li class="active"><a href="/shop">Shop</a></li>
                        <li><a href="#">Pages</a>
                            <ul class="dropdown">
                               
                                <li><a href="./shop">Shop</a></li>
                                <li><a href="./cart">Shopping Cart</a></li>
                                 <li><a href="./profile">Profile</a></li>
                                 <li><a href="./wallet">Wallet</a></li>
                                
                            </ul>
                        </li>
                        <li><a href="/wallet">Wallet</a></li>
                        
                    </ul>
                </nav>
            </div>
            <div class="col-lg-3 col-md-3" style="padding-left: 112px;">
              <div class="header__nav__option d-flex">
                  <a  href="" class="search-switch"><img src="img/icon/search.png" alt=""></a>
                  <a href="./cart"><img src="img/icon/cart.png" alt="cart"> </a>

                  <div style="width: 21px;
                  height: 21px; margin-right: 20px;">
                      <a href="./wallet"><img src="img/icon/wallet.png" alt="Profile"></i> </a>
                  </div>
                  
                  <div style="width: 19px;
                  height: 19px;">
                      <a href="./profile"><img src="img/icon/user.png" alt="Profile"> </a>
                  </div>
              </div>
          </div>
        </div>
        <div class="canvas__open"><i class="fa fa-bars"></i></div>
    </div>
</header>
<!-- Header Section End -->

    <!-- Breadcrumb Section Begin -->
    <section class="breadcrumb-option">
      <div class="container">
        <div class="row">
          <div class="col-lg-12">
            <div class="breadcrumb__text">
              <h4>Check Out</h4>
              <div class="breadcrumb__links">
                <a href="./home">Home</a>
                <a href="./shop">Shop</a>
                <span>Check Out</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- Breadcrumb Section End -->

    <!-- Checkout Section Begin -->

    <section class="checkout spad">
      <div class="container">
        <div class="checkout__form">
          <form action="#">
            <div class="row">
              <div class="col-lg-8 col-md-6">
                <div style="height: auto">
                  <div class="d-flex justify-content-end pt-2 px-2">
                    <button
                      type="button"
                      class="btn btn-primary"
                      data-toggle="modal"
                      data-target="#addAddressModal"
                    >
                      Add Address
                    </button>
                  </div>

                  <h2>Choose Addresse</h2>

                  <% if(Address.length==0){ %>
                  <div
                    style="
                      border: 1px solid;
                      border-color: black;
                      height: 100px;
                      text-align: center;
                    "
                  >
                    <h5 style="color: red; padding-top: 35px">
                      NO Address Found
                    </h5>
                  </div>

                  <% } %> <% Address.forEach(address => { %>
                  <div
                    style="
                      padding: 20px;
                      margin-top: 10px;
                      background-color: #f3f2ee;
                    "
                  >
                    <p><strong>Name:</strong> <%= address.fullname %></p>
                    <p><strong>City:</strong> <%= address.city %></p>
                    <p><strong>State:</strong> <%= address.state %></p>
                    <p><strong>Pin:</strong> <%= address.pincode %></p>
                    <p><strong>Phone:</strong> <%= address.phone %></p>
                    <input
                      type="radio"
                      name="address"
                      value="choosed"
                      id="addressradio"
                      data-address-id="<%= address._id %>"
                    />
                    <label for="address">Select</label><br />
                  </div>

                  <% }); %>
                </div>
              </div>

              

             
              <div class="col-lg-4 col-md-6">

                
                 
              
                  <div class="container d-flex flex-column align-items-start bg-light " >
                    <h4> <b>Coupons</b></h4>
                    
                    <div class="mt-2 ">
                      <select name="couponCode" class="form-control" id="selectedCoupon">
                        <option  value="" disabled selected>Select a coupon</option>
                        <% coupons.forEach(coupon => { %>
                            <% if (new Date(coupon.expiry) >= new Date()) { %>
                                <option value="<%= coupon.couponName %>" data-coupon="<%=coupon.discount%>">
                                    <%= coupon.couponName %> <%= coupon.discount %> off Offer validity <%= coupon.expiry.toLocaleDateString() %>
                                </option>
                            <% } %>
                        <% }); %>
                    </select>
                    </div>
                    <div class="mt-2 mb-2">
                        <button type="button" class="btn btn-success" onclick="applyCoupon()">Apply</button>
                    </div>
                
              </div>
              
              
              

                <div class="checkout__order" style=" margin-top: 17px;">
                  <h4 class="order__title">Your order</h4>
                  <div class="checkout__order__products">
                    Product <span>Total</span>
                  </div>
                  <ul class="checkout__total__products">
                    <% userCart.items.forEach(product=>{ %>

                    <li>
                      <%= product.productId.productName %>
                      <span
                        >&#8377;<%=
                        (product.productId.actualPrice-product.productId.offerAmound)*product.quantity %></span
                      >
                    </li>

                    <% }) %>
                  </ul>
                  <ul class="checkout__total__all">
                    
                    <li>Subtotal<span>&#8377; <span id="subTotal"><%= subtotal %></span></span></li>
                    <li>coupon <span>-<span>&#8377; <span id="couponAmount">0</span></span></span></li>
                    <!-- <li>coupon <span id="couponAmount">&#8377; 0</span></li> -->
                    <li>Total<span>&#8377; <span id="total"><%= subtotal %></span></span></li>
                  </ul>
                  <div class="checkout__input__checkbox" style="padding: 10px">
                    <h5>Payment Methods</h5>
                  </div>
                  <div class="checkout__input__checkbox">
                    <label for="payment">
                      Cash on Delivery
                      <input
                        type="radio"
                        id="payment"
                        name="paymentMethod"
                        value="COD"
                      />
                      <span class="checkmark"></span>
                    </label>
                  </div>

                  <div class="checkout__input__checkbox">
                    <label for="razorpay">
                      Online Payment
                      <input
                        type="radio"
                        id="razorpay"
                        name="paymentMethod"
                        value="Online"
                        checked
                      />
                      <span class="checkmark"></span>
                    </label>
                  </div>

                  <div class="checkout__input__checkbox">
                    <label for="Wallet">
                      Wallet Payment
                      <input
                        type="radio"
                        id="Wallet"
                        name="paymentMethod"
                        value="Wallet"
                      />
                      <span class="checkmark"></span>
                    </label>
                  </div>

                  <button type="button" class="site-btn" onclick="place()">
                    PLACE ORDER
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </section>
    <!-- Checkout Section End -->

    <!-- Modal -->
    <div class="modal" id="addAddressModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header">
            <h5 class="modal-title">Add Address</h5>
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>

          <!-- Modal Body -->
          <div class="modal-body">
            <!-- Form for adding address -->
            <form>
              <h4 id="addressmsg"></h4>
              <div class="form-group">
                <label for="address">Full Name:</label>
                <input
                  type="text"
                  class="form-control"
                  id="name"
                  placeholder="Enter your address"
                  required
                />
                <span id="nameerror" class="error"></span>
              </div>
              <div class="form-group">
                <label for="city">City:</label>
                <input
                  type="text"
                  class="form-control"
                  id="city"
                  placeholder="Enter your city"
                  required
                />
                <span id="cityerror" class="error"></span>
              </div>
              <div class="form-group">
                <label for="zipcode">State:</label>
                <input
                  type="text"
                  class="form-control"
                  id="state"
                  placeholder="Enter your state"
                  required
                />
                <span id="stateerror" class="error"></span>
              </div>
              <div class="form-group">
                <label for="zipcode">Pincode:</label>
                <input
                  type="text"
                  class="form-control"
                  id="pin"
                  placeholder="Enter your pin code"
                  required
                />
                <span id="pinerror" class="error"></span>
              </div>
              <div class="form-group">
                <label for="zipcode">Phone:</label>
                <input
                  type="text"
                  class="form-control"
                  id="phn"
                  placeholder="Enter your phone number"
                  required
                />
                <span id="phnerror" class="error"></span>
              </div>

              <button
                type="button"
                class="btn btn-primary"
                onclick="addAddress()"
              >
                Add
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- end of modal addaddress -->

    <!-- Footer Section Begin -->
    <footer class="footer">
      <div class="container">
        <div class="row">
          <div class="col-lg-3 col-md-6 col-sm-6">
            <div class="footer__about">
              <div class="footer__logo">
                <a href="#"><img src="img/ssLOGOW.png" alt="" /></a>
              </div>
              <p>
                The customer is at the heart of our unique business model, which
                includes design.
              </p>
              <a href="#"><img src="img/payment.png" alt="" /></a>
            </div>
          </div>
          <div class="col-lg-2 offset-lg-1 col-md-3 col-sm-6">
            <div class="footer__widget">
              <h6>Shopping</h6>
              <ul>
                <li><a href="#">Clothing Store</a></li>
                <li><a href="#">Trending Shoes</a></li>
                <li><a href="#">Accessories</a></li>
                <li><a href="#">Sale</a></li>
              </ul>
            </div>
          </div>
          <div class="col-lg-2 col-md-3 col-sm-6">
            <div class="footer__widget">
              <h6>Shopping</h6>
              <ul>
                <li><a href="#">Contact Us</a></li>
                <li><a href="#">Payment Methods</a></li>
                <li><a href="#">Delivary</a></li>
                <li><a href="#">Return & Exchanges</a></li>
              </ul>
            </div>
          </div>
          <div class="col-lg-3 offset-lg-1 col-md-6 col-sm-6">
            <div class="footer__widget">
              <h6>NewLetter</h6>
              <div class="footer__newslatter">
                <p>
                  Be the first to know about new arrivals, look books, sales &
                  promos!
                </p>
                <form action="#">
                  <input type="text" placeholder="Your email" />
                  <button type="submit">
                    <span class="icon_mail_alt"></span>
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>
    <!-- Footer Section End -->

    <!-- Search Begin -->
    <div class="search-model">
      <div class="h-100 d-flex align-items-center justify-content-center">
        <div class="search-close-switch">+</div>
        <form class="search-model-form">
          <input type="text" id="search-input" placeholder="Search here....." />
        </form>
      </div>
    </div>
    <!-- Search End -->

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>

      function applyCoupon(){
         const coupon = document.getElementById('selectedCoupon').value
         const total = document.getElementById('subTotal').innerText
         const Amount = parseInt(total)

         
         if(coupon !== ''){
          fetch('/ApplyCoupon',{
            method:'post',
            headers:{
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              coupon,Amount
              }),
          })
          .then(response =>{
            return response.json()
          })
          .then(data =>{
            if(data.value ===1){
              const discountedTotal = data.Discount
              document.getElementById('total').innerText=discountedTotal;
              document.getElementById('couponAmount').innerText=data.DiscountAmount;
              Swal.fire({
                position: "center",
                icon: "success",
                title: "Coupon Added",
                showConfirmButton: false,
                timer: 1000
              }); 
              
            }else{
              Swal.fire({
                position: "center",
                icon: "error",
                title: "Low Cart Amount",
                showConfirmButton: false,
                timer: 1500
              }); 
            }
          })

        }else{
          Swal.fire({
                position: "center",
                icon: "warning",
                title: "Select a Coupon",
                showConfirmButton: false,
                timer: 1500
              });
        }


      }




      function place() {
    const selectedRadio = document.querySelector('input[name="address"]:checked');
    const paymentMethodInput = document.querySelector('input[name="paymentMethod"]:checked').value;

    console.log(paymentMethodInput);

   
    const Total = document.getElementById("total").innerText;
    const couponAmount = document.getElementById('couponAmount').innerText;
    const discount = parseInt(couponAmount)
    

    

    if (!selectedRadio) {
    
        Swal.fire({
            position: "center",
            icon: "warning",
            title: "Select Address ",
            showConfirmButton: false,
            timer: 1500,
        });
        return; 
    }
    if (paymentMethodInput==null) {
        
        Swal.fire({
            position: "center",
            icon: "warning",
            title: "Select Payment Method ",
            showConfirmButton: false,
            timer: 1500,
        });
        return; // Exit the function to prevent further execution
    }

    var addressId = selectedRadio.getAttribute("data-address-id");

    

        if (selectedRadio && paymentMethodInput) {
          if (paymentMethodInput === "Online") {

            console.log('paymentilek kadannu');

            fetch("onlinePayment", {
              method: "post",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                addressId,
                Total,
                discount
              }),
            })
              .then((response) => {
               
                return response.json(); // Add 'return' statement here
              })
              .then((data) => {
                
                var Order = data.order;
                let Discount = data.discount;

                var options = {
                  key: "rzp_test_nwYxVyWUp78tNr",
                  amount: Order.amount,
                  currency: "INR",
                  name: "Sole Saavy",
                  description: "Test Transaction",
                  image: "https://example.com/your_logo",
                  order_id: Order.id,
                  handler: function (response) {
                  
                    verifyPayment(response, Order,Discount);
                  },
                  prefill: {
                    name: "Gaurav Kumar",
                    email: "gaurav.kumar@example.com",
                    contact: "9000090000",
                  },
                  notes: {
                    address: "Razorpay Corporate Office",
                  },
                  theme: {
                    color: "#3399cc",
                  },
                };

                var rzp1 = new Razorpay(options);

                rzp1.on("payment.failed", function (response) {
                  // Handle payment failure
                  console.error("Payment failed:", response);
                });

                rzp1.open();
              })
              .catch((error) => {
                console.error("Error fetching order details:", error);
                // Handle error (show user-friendly message, etc.)
              });
          } else if (paymentMethodInput === "COD") {
            fetch("placeOrder", {
              method: "post",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                addressId,
                Total,
                   discount
              }),
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.value === 1) {
                  Swal.fire({
                    position: "center",
                    icon: "success",
                    title: "Order Placed",
                    showConfirmButton: false,
                    timer: 1500,
                  });

                  setTimeout(() => {
                    window.location.href='/orderSuccess'
                  }, 1600);

                } else {
                  Swal.fire({
                    position: "center",
                    icon: "warning",
                    title: "Something went wrong",
                    showConfirmButton: false,
                    timer: 1500,
                  });
                }
              })
              .catch((error) => {
                console.error("Error placing order:", error);
                // Handle error appropriately, show an error message, etc.
              });
          }else if(paymentMethodInput === "Wallet"){
              
            fetch("walletOrder", {
              method: "post",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                addressId,
                Total,
                   discount
              }),
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.value === 10) {
                  Swal.fire({
                    position: "center",
                    icon: "error",
                    title: "Insufficient Balance",
                    showConfirmButton: false,
                    timer: 1500,
                  });

                  

                } else if(data.value === 1) {
                  Swal.fire({
                    position: "center",
                    icon: "success",
                    title: "Order Placed",
                    showConfirmButton: false,
                    timer: 1500,
                  });

                  setTimeout(() => {
                    window.location.href='/orderSuccess'
                  }, 1600);
                }
              })
              .catch((error) => {
                console.error("Error placing order:", error);
                // Handle error appropriately, show an error message, etc.
              });

          }else{
            console.log('unknown Payment Method');
          }
        }else{
          console.log("Either selectedRadio or paymentMeth is missing");
        }


        async function verifyPayment(payment, Order,Discount) {
          try {
            console.log('code on verifing');
            const response = await fetch("/verifyOnlinePayment", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ payment, Order, addressId, Total,Discount }),
            })
              .then((response) => {
                response.json();
                if(response.ok){
                  Swal.fire({
                    position: "center",
                    icon: "success",
                    title: "Order Placed",
                    showConfirmButton: false,
                    timer: 3500,
                  });

                  setTimeout(() => {
                    window.location.href="/orderSuccess"
                  }, 2000);
                }else{
                  Swal.fire({
                    position: "center",
                    icon: "warning",
                    title: "Something went wrong",
                    showConfirmButton: false,
                    timer: 1500,
                  });
                }
              })
            
          } catch (error) {
            // Handle error
            console.error(error);
          }
        }
      }

      function addAddress() {
        const Fullname = document.getElementById("name").value;
        const City = document.getElementById("city").value;
        const State = document.getElementById("state").value;
        const Pin = document.getElementById("pin").value;
        const Phone = document.getElementById("phn").value;

        const namereg = /^[a-zA-Z\s]{1,20}$/;
        if (!namereg.test(Fullname.trim())) {
          nameerror.textContent = "Invalid name";
          return false;
        } else {
          nameerror.textContent = "";
        }

        const cityreg = /^[a-zA-Z]{1,20}$/;
        if (!cityreg.test(City.trim())) {
          cityerror.textContent = "Invalid input";
          return false;
        } else {
          cityerror.textContent = "";
        }

        const statereg = /^[a-zA-Z]{1,20}$/;
        if (!statereg.test(State.trim())) {
          stateerror.textContent = "Invalid input";
          return false;
        } else {
          stateerror.textContent = "";
        }

        const pinreg = /^[0-9]{1,6}$/;
        if (!pinreg.test(Pin.trim())) {
          pinerror.textContent = "Invalid input";
          return false;
        } else {
          pinerror.textContent = "";
        }

        const phonereg = /^[0-9]{10}$/;
        if (!phonereg.test(Phone.trim())) {
          phnerror.textContent = "Invalid input";
          return false;
        } else {
          phnerror.textContent = "";
        }

        fetch("profile/addAddress", {
          method: "post",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            Fullname,
            City,
            State,
            Pin,
            Phone,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.value === 1) {
              const msg = document.getElementById("addressmsg");
              msg.innerText = "Address Added";
              msg.style.color = "green";
              setTimeout(() => {
                location.reload()
              }, 1000);
            } else {
              const msg = document.getElementById("addressmsg");
              msg.innerText = "Some thing Wrong";
              msg.style.color = "red";
            }
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }
    </script>

    <!-- Js Plugins -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.nice-select.min.js"></script>
    <script src="js/jquery.nicescroll.min.js"></script>
    <script src="js/jquery.magnific-popup.min.js"></script>
    <script src="js/jquery.countdown.min.js"></script>
    <script src="js/jquery.slicknav.js"></script>
    <script src="js/mixitup.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/main.js"></script>
  </body>
</html>
